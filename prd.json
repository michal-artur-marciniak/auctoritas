{
  "project": "Auctoritas",
  "branchName": "ralph/v0-3-1-password-reset-flow",
  "description": "v0.3.1 Password Reset Flow (End Users) - API-only reset request/completion with one-time tokens, session revocation, and password history.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add persistence for password reset tokens and password history",
      "description": "As a developer, I need secure persistence for reset tokens and password history so that the reset flow is safe and auditable.",
      "acceptanceCriteria": [
        "Add migration creating password_reset_tokens with: id, project_id, user_id, token_hash, expires_at, used_at, created_at, ip_address, user_agent",
        "Add migration creating password_history with: id, project_id, user_id, password_hash, created_at",
        "Raw reset tokens are never stored; only token_hash (e.g., SHA-256) is persisted",
        "Reset token expiry is 1 hour",
        "Migration runs cleanly on startup",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Request password reset endpoint",
      "description": "As an end user, I want to request a password reset so that I can regain access if I forgot my password.",
      "acceptanceCriteria": [
        "POST /api/v1/auth/password/forgot accepts { email } and requires X-API-Key",
        "Response is always generic success (no user enumeration)",
        "A reset token record is created only when the email exists for that project",
        "Any previously active reset tokens for the same user+project are invalidated",
        "A domain event user.password_reset_requested is emitted (RabbitMQ)",
        "A stub email payload (incl. token for dev) is logged without storing the raw token",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Complete password reset using token",
      "description": "As an end user, I want to set a new password using the reset token so that I can access my account again.",
      "acceptanceCriteria": [
        "POST /api/v1/auth/password/reset accepts { token, newPassword } and requires X-API-Key",
        "Reset token validation checks: exists, not expired, not used, matches project, matches user",
        "Reset token is one-time use (marked used and cannot be replayed)",
        "Password history is enforced (cannot reuse last N passwords; default N=5)",
        "On success, all refresh tokens/sessions for that user+project are revoked (logout everywhere)",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Change password while authenticated",
      "description": "As an end user, I want to change my password while logged in so that I can rotate credentials proactively.",
      "acceptanceCriteria": [
        "PUT /api/v1/users/me/password requires Authorization: Bearer <end-user-jwt> and X-API-Key",
        "Endpoint accepts { currentPassword, newPassword } and verifies currentPassword",
        "Password history is enforced (cannot reuse last N passwords; default N=5)",
        "On success, refresh tokens/sessions are revoked except the current session (keep-current behavior is explicit and documented)",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Add operational safety (rate limits and structured logging)",
      "description": "As an operator, I want the reset flow to be rate-limited and logged so that abuse is mitigated.",
      "acceptanceCriteria": [
        "Gateway rate limits apply to POST /api/v1/auth/password/forgot (SDK endpoints)",
        "Auth service logs include correlation IDs and key fields (project id, anonymized user id, outcome) for reset flows",
        "Failed reset attempts are recorded without leaking sensitive details",
        "mvn -pl backend/services/gateway-service test passes",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    }
  ]
}
