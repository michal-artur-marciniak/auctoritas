{
  "project": "Auctoritas",
  "branchName": "feature/v0-4-0-oauth-google",
  "description": "v0.4.0 OAuth Integration (Google) - Redirect-based OAuth with PKCE/state and one-time exchange codes (no tokens in URL).",
  "userStories": [
    {
      "id": "US-001",
      "title": "Persist OAuth connections",
      "description": "As a developer, I need OAuth connections persisted so that future logins can identify users.",
      "acceptanceCriteria": [
        "Add migration creating oauth_connections with: id, project_id, user_id, provider, provider_user_id, email, created_at, updated_at",
        "Enforce uniqueness: one connection per provider+provider_user_id per project",
        "Migration runs cleanly on startup",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Configure Google OAuth per project",
      "description": "As a project admin, I want to configure Google OAuth credentials so that users can sign in with Google.",
      "acceptanceCriteria": [
        "Project settings support Google OAuth fields: enabled, clientId, clientSecret",
        "clientSecret is stored encrypted at rest and never returned in full via API",
        "Project settings include an allowlist of redirectUris for OAuth",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Start Google OAuth authorization",
      "description": "As an end user, I want to start Google sign-in so that I can authenticate without a password.",
      "acceptanceCriteria": [
        "GET /api/v1/auth/oauth/google/authorize?redirect_uri=... requires X-API-Key",
        "redirect_uri is validated against the project's redirectUris allowlist",
        "System generates state and PKCE verifier/challenge and persists them server-side with short TTL",
        "Response is an HTTP 302 redirect to Google's authorize URL with required parameters",
        "mvn -pl backend/services/gateway-service test passes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Handle Google OAuth callback and redirect to app with exchange code",
      "description": "As the platform, I want to handle the provider callback so that the user returns to the app with an exchange code.",
      "acceptanceCriteria": [
        "GET /api/v1/auth/oauth/google/callback?code=...&state=... validates state and retrieves PKCE verifier",
        "System exchanges provider code for provider tokens using stored PKCE verifier",
        "If a user with matching email exists in the project, link OAuth connection to that user; otherwise create a new user",
        "New users created via Google are marked emailVerified=true",
        "Callback redirects to validated redirect_uri with auctoritas_code=<one-time-code> (TTL <= 2 minutes)",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Exchange code for Auctoritas tokens",
      "description": "As an app client, I want to exchange the redirect code for Auctoritas tokens so that I can establish a session.",
      "acceptanceCriteria": [
        "POST /api/v1/auth/oauth/exchange requires X-API-Key and accepts { code }",
        "Exchange code is one-time use and expires quickly (<= 2 minutes)",
        "On success, response matches existing login format: { user, accessToken, refreshToken }",
        "Exchange code cannot be replayed",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    }
  ]
}
