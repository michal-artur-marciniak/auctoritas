{
  "project": "Auctoritas",
  "branchName": "feature/v0-3-2-email-verification",
  "description": "v0.3.2 Email Verification (End Users) - API-only verification and resend with project-scoped settings and stubbed email events.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add secure persistence for email verification challenges",
      "description": "As a developer, I need secure persistence for verification challenges so that verification is tamper-resistant.",
      "acceptanceCriteria": [
        "Add migration creating email_verification_tokens with: id, project_id, user_id, token_hash, code_hash, expires_at, used_at, created_at",
        "Raw verification code and raw token are never stored; only hashes are stored",
        "Verification code is 6 digits and expires after 24 hours",
        "Migration runs cleanly on startup",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Generate verification token+code on registration",
      "description": "As a developer, I want new users to receive an email verification challenge so that emails can be verified.",
      "acceptanceCriteria": [
        "On successful POST /api/v1/auth/register, the system creates an email verification record for that user+project",
        "A verification code (6 digits) and opaque token are generated; only hashes are persisted",
        "User is created with emailVerified=false",
        "A domain event user.registered is emitted and a stub verification email payload is logged (includes code + token for dev)",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Verify email using token+code",
      "description": "As an end user, I want to verify my email so that my account is trusted.",
      "acceptanceCriteria": [
        "POST /api/v1/auth/register/verify-email requires X-API-Key and accepts { token, code }",
        "Verification succeeds only if token+code match the same verification record and it is not expired/used",
        "On success, user is marked emailVerified=true and verification record is invalidated (one-time)",
        "Subsequent verify attempts with the same token fail",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Resend verification with abuse controls",
      "description": "As an end user, I want to request another verification email so that I can complete verification if I lost the first one.",
      "acceptanceCriteria": [
        "POST /api/v1/auth/register/resend-verification requires X-API-Key and accepts { email }",
        "Response is generic success regardless of whether the email exists (no enumeration)",
        "If user exists and is unverified, prior verification records are invalidated and a new token+code is created",
        "Auth service enforces resend rate limit per user+project (e.g., max 3 per hour) in addition to gateway rate limits",
        "A stub verification email payload is logged and a domain event is emitted",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Require verified email before login (optional project setting)",
      "description": "As a project admin, I want to optionally require verified emails so that unverified accounts cannot log in.",
      "acceptanceCriteria": [
        "Add project setting requireVerifiedEmailForLogin (boolean), default false",
        "When requireVerifiedEmailForLogin=true, POST /api/v1/auth/login rejects logins for unverified users with an explicit error code",
        "When requireVerifiedEmailForLogin=false, login is allowed and JWT includes an emailVerified claim",
        "mvn -pl backend/services/auth-service test passes",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    }
  ]
}
