## Codebase Patterns
- SDK-facing auth endpoints should validate X-API-Key via ApiKeyService to resolve the Project context.
- Password policy for end-user flows is derived from ProjectSettings (min length, uppercase, numbers, special chars).
- End-user login lockouts use ProjectSettings failedLoginMaxAttempts/failedLoginWindowSeconds and EndUser failedLogin fields.
- End-user JWTs are authenticated via EndUserPrincipal from JwtAuthenticationFilter; use @AuthenticationPrincipal EndUserPrincipal for SDK auth endpoints.
- End-user access JWTs include `email_verified` (JwtService.CLAIM_EMAIL_VERIFIED); keep register/login/refresh token issuance aligned.
- Refresh token rotation should lock the refresh token row to prevent concurrent reuse.
- End-user password reset tokens are stored hashed with 1-hour expiry and a used_at marker for single-use enforcement.
- Password history enforcement should use ProjectSettings.passwordHistoryCount; treat <=0 as default 5 and compare via PasswordEncoder.matches.
- For end-user password changes that keep the current session, accept `X-Session-Id` (end-user access JWTs don't carry session ids); if selecting a "current" session/token from the DB, use `@Lock(PESSIMISTIC_WRITE)` to avoid races.
- End-user email verification tokens are stored hashed with 24-hour expiry and a used_at marker; resends mark existing tokens used.
- For tests that need plaintext verification token/code, call `EndUserEmailVerificationService.issueVerificationToken(...)`; persistence only stores hashes.
- In Spring Boot 4 tests, prefer overriding beans via `@TestConfiguration` + `@Primary` (e.g., to capture DomainEventPublisher publishes); `@MockBean` isn't available here.
- Per-service Maven runs should include `-am` to build local libs (e.g. `mvn -pl services/auth-service -am test`) so `dev.auctoritas:common` resolves.
- Email verification dev logging can be toggled via `auctoritas.auth.email-verification.log-challenge` (defaults true).
- Project auth settings are updated via `PUT /api/v1/org/{orgId}/projects/{projectId}/settings/auth`.
- Gateway SDK routes resolve API keys via /internal/api-keys/resolve and forward X-Project-Id.
- Maven modules live under `backend/`; run per-service tests from there (e.g. `mvn -pl services/auth-service test`).
- Auth-service repository tests rely on Hibernate DDL from entity mappings (keep Flyway migrations and JPA entities in sync).
- Domain events from auth-service use DomainEventPublisher; RabbitMQ publishes JSON to the default exchange with routing key = event type (disable in tests via `auctoritas.messaging.rabbit.enabled=false` and `spring.rabbitmq.dynamic=false`).
- For structured service logs, prefer `StructuredArguments.kv(...)` so LogstashEncoder emits searchable JSON fields; correlation id is carried via MDC key `correlationId`.
- In JPA tests, if you `entityManager.clear()`, re-fetch entities (find/getReference) before persisting new rows with @ManyToOne relations.

## 2026-01-27 11:35 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added project-scoped email verification token persistence via the new `email_verification_tokens` table and aligned JPA mappings.
- Files changed: backend/services/auth-service/src/main/resources/db/migration/V15__email_verification_tokens.sql, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserEmailVerificationToken.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserEmailVerificationService.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: If a token must be project-scoped, persist `project_id` explicitly (don't rely on joining through user) and validate it against the API key's project.
  - Gotchas encountered: Auth-service tests run with Flyway disabled and rely on Hibernate DDL; keep entity mappings consistent with new migrations.
  - Useful context: Email verification uses TokenService SHA-256 (Base64url) hashes; raw token/code never touch the DB and codes expire after 24h.
---

## 2026-01-27 11:50 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- On end-user registration, issued an email verification token+code (hashed persistence) and emitted the `user.registered` domain event.
- Added dev stub logging for verification email payload (includes plaintext code+token).
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRegistrationService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/messaging/UserRegisteredEvent.java, backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/EndUserRegistrationServiceTest.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Prefer emitting domain events from the service layer (not controllers) and keep secrets out of the event payload; log dev-only secrets behind a property.
  - Gotchas encountered: `mvn -pl services/auth-service test` can fail if local modules aren't installed; use `-am` to build reactor deps.
  - Useful context: Registration now logs a "Stub verification email" entry with `verificationToken` + `verificationCode` when `auctoritas.auth.email-verification.log-challenge=true`.
---

## 2026-01-27 12:05 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified the email verification flow: correct token+code marks the user as verified and invalidates the token.
- Added coverage for error cases (reused token, expired token, mismatched code).
- Files changed: backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/EndUserEmailVerificationServiceTest.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Use `EndUserEmailVerificationService.issueVerificationToken(...)` in tests to get plaintext token+code while persisting only hashes.
  - Gotchas encountered: Verification token lookups use `@Lock(PESSIMISTIC_WRITE)`; clear the EntityManager between steps when asserting persisted state.
  - Useful context: Verification sets `EndUser.emailVerified=true` and marks `EndUserEmailVerificationToken.usedAt` for one-time enforcement.
---

## 2026-01-27 12:13 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented resend verification behavior: generic success response, invalidates prior verification tokens, issues a fresh token+code, emits a domain event, and logs a dev-only stub email payload.
- Added per-user+project resend abuse controls (max 3/hour) based on recent verification token issuance.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserEmailVerificationService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserEmailVerificationTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/messaging/EmailVerificationResentEvent.java, backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/EndUserEmailVerificationServiceTest.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Use existing token tables + `createdAt` to implement low-friction rate limits without new schema.
  - Gotchas encountered: Bean overrides in tests are easiest via `@TestConfiguration` + `@Primary` (this project setup doesn't include `@MockBean`).
  - Useful context: Resend is intentionally non-enumerating; even rate-limited requests return the same generic success message and simply skip issuing a new token.
---

## 2026-01-27 12:25 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added ProjectSettings.requireVerifiedEmailForLogin (default false) and exposed it via `PUT /api/v1/org/{orgId}/projects/{projectId}/settings/auth`.
- Enforced verified-email requirement in end-user login when enabled (returns `email_not_verified`), and added `email_verified` claim to end-user access JWTs.
- Files changed: backend/services/auth-service/src/main/resources/db/migration/V17__project_settings_require_verified_email_for_login.sql, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/project/ProjectSettings.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/ProjectAuthSettingsRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/ProjectSettingsResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/ProjectController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/ProjectService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserLoginService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRegistrationService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRefreshService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/JwtService.java, backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/EndUserLoginServiceTest.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Keep ProjectSettings changes, migrations, and ProjectSettingsResponse mapping in sync (tests rely on Hibernate DDL but migrations must still reflect schema).
  - Gotchas encountered: End-user access tokens are minted in multiple flows (register/login/refresh) so JWT claim additions must be updated everywhere.
  - Useful context: `email_verified` is exposed as JwtService.CLAIM_EMAIL_VERIFIED and can be used downstream without changing EndUserPrincipal.
---
