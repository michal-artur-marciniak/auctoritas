## Codebase Patterns
- SDK-facing auth endpoints should validate X-API-Key via ApiKeyService to resolve the Project context.
- Password policy for end-user flows is derived from ProjectSettings (min length, uppercase, numbers, special chars).
- End-user login lockouts use ProjectSettings failedLoginMaxAttempts/failedLoginWindowSeconds and EndUser failedLogin fields.
- End-user JWTs are authenticated via EndUserPrincipal from JwtAuthenticationFilter; use @AuthenticationPrincipal EndUserPrincipal for SDK auth endpoints.
- End-user access JWTs include `email_verified` (JwtService.CLAIM_EMAIL_VERIFIED); keep register/login/refresh token issuance aligned.
- Refresh token rotation should lock the refresh token row to prevent concurrent reuse.
- End-user password reset tokens are stored hashed with 1-hour expiry and a used_at marker for single-use enforcement.
- Password history enforcement should use ProjectSettings.passwordHistoryCount; treat <=0 as default 5 and compare via PasswordEncoder.matches.
- For end-user password changes that keep the current session, accept `X-Session-Id` (end-user access JWTs don't carry session ids); if selecting a "current" session/token from the DB, use `@Lock(PESSIMISTIC_WRITE)` to avoid races.
- End-user email verification tokens are stored hashed with 24-hour expiry and a used_at marker; resends mark existing tokens used.
- For tests that need plaintext verification token/code, call `EndUserEmailVerificationService.issueVerificationToken(...)`; persistence only stores hashes.
- In Spring Boot 4 tests, prefer overriding beans via `@TestConfiguration` + `@Primary` (e.g., to capture DomainEventPublisher publishes); `@MockBean` isn't available here.
- In `@DataJpaTest` slices, Spring won't component-scan new `@Service/@Component` beans; add them via `@Import(...)` or a `@TestConfiguration`.
- For JPA repository constraint tests, persist duplicates then assert `entityManager.flush()` throws `jakarta.persistence.PersistenceException`.
- Per-service Maven runs should include `-am` to build local libs (e.g. `mvn -pl services/auth-service -am test`) so `dev.auctoritas:common` resolves.
- Email verification dev logging can be toggled via `auctoritas.auth.email-verification.log-challenge` (defaults true).
- Project auth settings are updated via `PUT /api/v1/org/{orgId}/projects/{projectId}/settings/auth`.
- Gateway SDK routes resolve API keys via /internal/api-keys/resolve and forward X-Project-Id.
- For gateway endpoints that need dynamic responses (e.g., OAuth redirects), implement a `*GatewayFilterFactory` and attach it to a dedicated route so route filters (like `RequestRateLimiter`) still apply.
- New auth-service `/internal/**` endpoints used by gateway must be added to `SecurityConfig.PUBLIC_ENDPOINTS` (they return `{"error":...}` via `ApiExceptionHandler`).
- Any API-key-only `/api/v1/**` endpoint (no end-user JWT yet) must be added to `SecurityConfig.PUBLIC_ENDPOINTS`, otherwise Spring Security will reject the request before ApiKeyService runs.
- Maven modules live under `backend/`; run per-service tests from there (e.g. `mvn -pl services/auth-service test`).
- Auth-service repository tests rely on Hibernate DDL from entity mappings (keep Flyway migrations and JPA entities in sync).
- Auth-service Spring tests may load `src/test/resources/application-test.yml` even when `src/main/resources/application-test.yml` exists; add required properties for new beans there to avoid ApplicationContext failures.
- Domain events from auth-service use DomainEventPublisher; RabbitMQ publishes JSON to the default exchange with routing key = event type (disable in tests via `auctoritas.messaging.rabbit.enabled=false` and `spring.rabbitmq.dynamic=false`).
- For structured service logs, prefer `StructuredArguments.kv(...)` so LogstashEncoder emits searchable JSON fields; correlation id is carried via MDC key `correlationId`.
- In JPA tests, if you `entityManager.clear()`, re-fetch entities (find/getReference) before persisting new rows with @ManyToOne relations.
- When linking OAuth identities, set `EndUser.emailVerified=true` only when the provider asserts the email is verified; do not link existing users by unverified email.
- Keep OAuth account linking provider-agnostic in `OAuthAccountLinkingService` (providers should only map userinfo, not enforce linking rules).
- OAuth provider `clientSecret` values are stored encrypted in `ProjectSettings` columns (never in `oauth_config`); API responses return `clientSecretSet` + masked `clientSecret`.
- When adding a new OAuth provider to project settings, update both `ProjectService.updateOAuthSettings(...)` (patch/validation/encryption) and `ProjectService.toSafeOauthConfig(...)` (masking), and add a Flyway migration for the encrypted secret column.
- Provider secrets that are not named `clientSecret` (e.g., Apple `privateKey`) should still follow the same rule: never persist plaintext in `oauth_config`; store encrypted in a `ProjectSettings` column and expose only a masked value + `*Set` flag.

## 2026-01-27 21:50 CET - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented an `OAuthProvider` interface + `OAuthProviderRegistry`, and moved Google token exchange/userinfo fetch behind `GoogleOAuthProvider`.
- Updated Google authorize/callback services to use the provider abstraction.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/OAuthProvider.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/OAuthProviderRegistry.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/GoogleOAuthProvider.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthGoogleAuthorizationService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthGoogleCallbackService.java`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/OAuthGoogleCallbackServiceTest.java`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - `OAuthProvider` should own provider-specific config parsing + token exchange + userinfo mapping; keep account linking logic provider-agnostic.
  - Use `OAuthProviderRegistry.require("<provider>")` to fail fast with `oauth_provider_invalid` for unknown providers.
  - In `@DataJpaTest` service tests, remember to `@Import` new provider/registry beans (slice tests don't component-scan).
---

## 2026-01-27 21:55 CET - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Centralized OAuth callback linking rules (connection by provider_user_id -> verified email match -> create) into `OAuthAccountLinkingService`.
- Updated Google callback + provider to stop rejecting unverified emails; only set `emailVerified=true` when provider asserts verified email.
- Added/updated tests to cover the three linking branches.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/OAuthAccountLinkingService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/GoogleOAuthProvider.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthGoogleCallbackService.java`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/OAuthGoogleCallbackServiceTest.java`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Keep provider implementations focused on userinfo mapping; apply account-linking rules in a shared service so future providers behave consistently.
  - Donâ€™t block logins on `emailVerified=false`; instead carry the flag through and only link-by-email when verified.
---

## 2026-01-27 22:05 CET - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added GitHub OAuth project settings support (enabled/clientId/redirectUris) with `clientSecret` stored encrypted at rest.
- Ensured API responses never return the plaintext secret (return `clientSecretSet` + masked `clientSecret`).
- Added allowlist validation so GitHub `redirectUris` must be a subset of the project's OAuth `redirectUris` allowlist.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/project/ProjectSettings.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/ProjectService.java`, `backend/services/auth-service/src/main/resources/db/migration/V22__project_settings_github_oauth_secret.sql`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/ProjectServiceOAuthSettingsTest.java`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Follow the existing pattern: provider config lives in `oauth_config` (no secrets), secrets live in dedicated encrypted columns, and `ProjectService.toSafeOauthConfig(...)` is responsible for masking.
  - If you introduce provider-specific `redirectUris`, validate them against the top-level OAuth allowlist early to avoid misconfig/security drift.
---

## 2026-01-27 22:20 CET - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented GitHub OAuth end-to-end across auth-service and gateway-service (authorize -> GitHub -> callback -> redirect with `auctoritas_code`).
- Auth-service: added `GitHubOAuthProvider` + `GitHubOAuthClient` and internal endpoints `/internal/oauth/github/authorize|callback` mirroring the Google flow.
- Gateway-service: added `GitHubOAuthAuthorizeGatewayFilterFactory` + `GitHubOAuthCallbackGatewayFilterFactory`, routes for `/api/v1/auth/oauth/github/authorize|callback`, and skipped API key enforcement on the public callback path.
- Tests: added auth-service `OAuthGitHubCallbackServiceTest`; updated gateway `OAuthGatewayFiltersTest` for GitHub; fixed a test syntax error; ran `mvn -pl services/auth-service -am test` and `mvn -pl services/gateway-service -am test`.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/GitHubOAuthProvider.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/GitHubOAuthClient.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/DefaultGitHubOAuthClient.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthGitHubAuthorizationService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthGitHubCallbackService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalGitHubOAuthController.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalGitHubAuthorizeRequest.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalGitHubAuthorizeResponse.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalGitHubCallbackRequest.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalGitHubCallbackResponse.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/OAuthGitHubCallbackServiceTest.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/GitHubOAuthAuthorizeGatewayFilterFactory.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/GitHubOAuthCallbackGatewayFilterFactory.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/ApiKeyGatewayFilter.java`, `backend/services/gateway-service/src/main/resources/application.yml`, `backend/services/gateway-service/src/test/java/dev/auctoritas/gateway/filter/OAuthGatewayFiltersTest.java`, `prd.json`, `progress.txt`.
---

## 2026-01-27 22:32 CET - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added Microsoft OAuth project settings support (enabled/clientId/tenant/redirectUris) with `clientSecret` stored encrypted at rest.
- Ensured API responses never return the plaintext secret (return `clientSecretSet` + masked `clientSecret`) and never persist plaintext secrets in `oauth_config`.
- Added allowlist validation so Microsoft `redirectUris` must be a subset of the project's OAuth `redirectUris` allowlist.
- Tests: extended `ProjectServiceOAuthSettingsTest` for Microsoft secret masking + allowlist enforcement; ran `mvn -pl services/auth-service -am test`.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/project/ProjectSettings.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/ProjectService.java`, `backend/services/auth-service/src/main/resources/db/migration/V23__project_settings_microsoft_oauth_secret.sql`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/ProjectServiceOAuthSettingsTest.java`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Follow the existing provider settings pattern: secrets in encrypted `ProjectSettings` columns; provider config in `oauth_config`; masking is centralized in `ProjectService.toSafeOauthConfig(...)`.
  - Provider `redirectUris` should be validated against the top-level OAuth allowlist to prevent misconfig/security drift.
---

## 2026-01-27 22:45 CET - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Microsoft OAuth end-to-end across auth-service and gateway-service (authorize -> Microsoft -> callback -> redirect with `auctoritas_code`).
- Auth-service: added `MicrosoftOAuthProvider` + `MicrosoftOAuthClient` and internal endpoints `/internal/oauth/microsoft/authorize|callback` mirroring the Google/GitHub flow.
- Gateway-service: added `MicrosoftOAuthAuthorizeGatewayFilterFactory` + `MicrosoftOAuthCallbackGatewayFilterFactory`, routes for `/api/v1/auth/oauth/microsoft/authorize|callback`, and skipped API key enforcement on the public callback path.
- Tests: added auth-service `OAuthMicrosoftCallbackServiceTest`; updated gateway `OAuthGatewayFiltersTest` for Microsoft; ran `mvn -pl services/auth-service -am test` and `mvn -pl services/gateway-service -am test`.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/MicrosoftOAuthClient.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/DefaultMicrosoftOAuthClient.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/MicrosoftOAuthProvider.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthMicrosoftAuthorizationService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthMicrosoftCallbackService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalMicrosoftOAuthController.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalMicrosoftAuthorizeRequest.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalMicrosoftAuthorizeResponse.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalMicrosoftCallbackRequest.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalMicrosoftCallbackResponse.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/OAuthMicrosoftCallbackServiceTest.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/MicrosoftOAuthAuthorizeGatewayFilterFactory.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/MicrosoftOAuthCallbackGatewayFilterFactory.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/ApiKeyGatewayFilter.java`, `backend/services/gateway-service/src/main/resources/application.yml`, `backend/services/gateway-service/src/test/java/dev/auctoritas/gateway/filter/OAuthGatewayFiltersTest.java`, `prd.json`, `progress.txt`.
---

## 2026-01-27 22:50 CET - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added Facebook OAuth project settings support (enabled/clientId/redirectUris) with `clientSecret` stored encrypted at rest.
- Ensured API responses never return the plaintext secret (return `clientSecretSet` + masked `clientSecret`) and never persist plaintext secrets in `oauth_config`.
- Added allowlist validation so Facebook `redirectUris` must be a subset of the project's OAuth `redirectUris` allowlist.
- Tests: extended `ProjectServiceOAuthSettingsTest` for Facebook secret masking + allowlist enforcement; ran `mvn -pl services/auth-service -am test`.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/project/ProjectSettings.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/ProjectService.java`, `backend/services/auth-service/src/main/resources/db/migration/V24__project_settings_facebook_oauth_secret.sql`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/ProjectServiceOAuthSettingsTest.java`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - New provider settings should follow the existing pattern: secrets in encrypted `ProjectSettings` columns, config in `oauth_config`, and masking centralized in `ProjectService.toSafeOauthConfig(...)`.
  - Provider-specific `redirectUris` should be validated against the top-level OAuth allowlist (`redirectUris`) to prevent misconfig/security drift.
---

## 2026-01-27 23:00 CET - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Facebook OAuth end-to-end across auth-service and gateway-service (authorize -> Facebook -> callback -> redirect with `auctoritas_code`).
- Auth-service: added `FacebookOAuthProvider` + `FacebookOAuthClient` and internal endpoints `/internal/oauth/facebook/authorize|callback`, using PKCE and shared account-linking rules.
- Gateway-service: added `FacebookOAuthAuthorizeGatewayFilterFactory` + `FacebookOAuthCallbackGatewayFilterFactory`, routes for `/api/v1/auth/oauth/facebook/authorize|callback`, and skipped API key enforcement on the public callback path.
- Tests: added auth-service `OAuthFacebookCallbackServiceTest`; extended gateway `OAuthGatewayFiltersTest` for Facebook; fixed a gateway test compilation issue.
- Verified by running `mvn -pl services/auth-service -am test` and `mvn -pl services/gateway-service -am test`.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/oauth/FacebookOAuthProvider.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/FacebookOAuthClient.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/DefaultFacebookOAuthClient.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthFacebookAuthorizationService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/OAuthFacebookCallbackService.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalFacebookOAuthController.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalFacebookAuthorizeRequest.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalFacebookAuthorizeResponse.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalFacebookCallbackRequest.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/InternalFacebookCallbackResponse.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/OAuthFacebookCallbackServiceTest.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/FacebookOAuthAuthorizeGatewayFilterFactory.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/FacebookOAuthCallbackGatewayFilterFactory.java`, `backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/ApiKeyGatewayFilter.java`, `backend/services/gateway-service/src/main/resources/application.yml`, `backend/services/gateway-service/src/test/java/dev/auctoritas/gateway/filter/OAuthGatewayFiltersTest.java`, `prd.json`, `progress.txt`.
---

## 2026-01-27 23:20 CET - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added Apple Sign-In project settings support (enabled/teamId/keyId/serviceId/redirectUris) with `privateKey` stored encrypted at rest.
- Ensured API responses never return the plaintext key (return `privateKeySet` + masked `privateKey`) and never persist plaintext keys in `oauth_config`.
- Added allowlist validation so Apple `redirectUris` must be a subset of the project's OAuth `redirectUris` allowlist.
- Files changed: `backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/project/ProjectSettings.java`, `backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/ProjectService.java`, `backend/services/auth-service/src/main/resources/db/migration/V25__project_settings_apple_sign_in_secret.sql`, `backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/ProjectServiceOAuthSettingsTest.java`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - For provider secrets that don't map cleanly to `clientSecret` (Apple `privateKey`), keep the same ergonomics: `*Set` boolean + masked secret in `toSafeOauthConfig(...)`, and never store plaintext in `oauth_config`.
  - When adding provider-specific `redirectUris`, validate against the top-level OAuth allowlist (`redirectUris`) to prevent misconfig/security drift.
---
