## Codebase Patterns
- SDK-facing auth endpoints should validate X-API-Key via ApiKeyService to resolve the Project context.
- Password policy for end-user flows is derived from ProjectSettings (min length, uppercase, numbers, special chars).
- End-user login lockouts use ProjectSettings failedLoginMaxAttempts/failedLoginWindowSeconds and EndUser failedLogin fields.
- End-user JWTs are authenticated via EndUserPrincipal from JwtAuthenticationFilter; use @AuthenticationPrincipal EndUserPrincipal for SDK auth endpoints.
- Refresh token rotation should lock the refresh token row to prevent concurrent reuse.

## 2026-01-26 19:32 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user registration endpoint with API key validation, password policy enforcement, token issuance, and session creation.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRegistrationRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRegistrationResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUser.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserRefreshToken.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserSession.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRefreshTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserSessionRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRegistrationService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/JwtService.java, backend/services/auth-service/src/main/resources/db/migration/V8__end_users.sql, prd.json, progress.txt
- **Learnings for future iterations:** Public unauthenticated endpoints must be added to SecurityConfig.PUBLIC_ENDPOINTS; end-user session/device info should be captured from User-Agent and X-Forwarded-For headers; TokenService.getRefreshTokenExpiry is the shared source of refresh token TTL.
---

## 2026-01-26 19:37 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user login endpoint with API key validation, failure tracking, lockout enforcement, and session/token issuance.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserLoginRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserLoginResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUser.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/project/ProjectSettings.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserLoginService.java, backend/services/auth-service/src/main/resources/db/migration/V9__end_user_login_security.sql, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: End-user logins update the existing session from EndUserSessionRepository.findByUserId when available.
  - Gotchas encountered: Add new auth endpoints to SecurityConfig.PUBLIC_ENDPOINTS or they will require JWT.
  - Useful context: Login lockout defaults are stored on ProjectSettings and enforced via EndUser failed_login fields.
---

## 2026-01-26 19:45 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user logout endpoint with end-user JWT authentication, API key validation, and session/refresh token invalidation.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserLogoutResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRefreshTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserSessionRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/security/EndUserPrincipal.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/security/JwtAuthenticationFilter.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserLogoutService.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: End-user JWTs now surface an EndUserPrincipal for SDK auth endpoints like logout.
  - Gotchas encountered: Logout requires both X-API-Key and a valid end-user JWT; missing either yields 401.
  - Useful context: Logout revokes refresh tokens via EndUserRefreshTokenRepository.revokeActiveByUserId and deletes sessions via EndUserSessionRepository.deleteByUserId.
---

## 2026-01-26 19:52 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user refresh endpoint with API key validation, refresh token rotation, and session refresh.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRefreshRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRefreshResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRefreshTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRefreshService.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Refresh flows should rotate tokens by revoking the old refresh token and linking it to the replacement.
  - Gotchas encountered: End-user refresh endpoints must be added to SecurityConfig.PUBLIC_ENDPOINTS to avoid JWT gating.
  - Useful context: Refresh updates EndUserSession expiry alongside issuing new tokens.
---
