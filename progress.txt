## Codebase Patterns
- SDK-facing auth endpoints should validate X-API-Key via ApiKeyService to resolve the Project context.
- Password policy for end-user flows is derived from ProjectSettings (min length, uppercase, numbers, special chars).
- End-user login lockouts use ProjectSettings failedLoginMaxAttempts/failedLoginWindowSeconds and EndUser failedLogin fields.
- End-user JWTs are authenticated via EndUserPrincipal from JwtAuthenticationFilter; use @AuthenticationPrincipal EndUserPrincipal for SDK auth endpoints.
- Refresh token rotation should lock the refresh token row to prevent concurrent reuse.
- End-user password reset tokens are stored hashed with 1-hour expiry and a used_at marker for single-use enforcement.
- Password history enforcement should use ProjectSettings.passwordHistoryCount; treat <=0 as default 5 and compare via PasswordEncoder.matches.
- End-user email verification tokens are stored hashed with 24-hour expiry and a used_at marker; resends mark existing tokens used.
- Gateway SDK routes resolve API keys via /internal/api-keys/resolve and forward X-Project-Id.
- Maven modules live under `backend/`; run per-service tests from there (e.g. `mvn -pl services/auth-service test`).
- Auth-service repository tests rely on Hibernate DDL from entity mappings (keep Flyway migrations and JPA entities in sync).
- Domain events from auth-service use DomainEventPublisher; RabbitMQ publishes JSON to the default exchange with routing key = event type (disable in tests via `auctoritas.messaging.rabbit.enabled=false` and `spring.rabbitmq.dynamic=false`).
- In JPA tests, if you `entityManager.clear()`, re-fetch entities (find/getReference) before persisting new rows with @ManyToOne relations.

## 2026-01-26 19:32 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user registration endpoint with API key validation, password policy enforcement, token issuance, and session creation.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRegistrationRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRegistrationResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUser.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserRefreshToken.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserSession.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRefreshTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserSessionRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRegistrationService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/JwtService.java, backend/services/auth-service/src/main/resources/db/migration/V8__end_users.sql, prd.json, progress.txt
- **Learnings for future iterations:** Public unauthenticated endpoints must be added to SecurityConfig.PUBLIC_ENDPOINTS; end-user session/device info should be captured from User-Agent and X-Forwarded-For headers; TokenService.getRefreshTokenExpiry is the shared source of refresh token TTL.
---

## 2026-01-26 19:37 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user login endpoint with API key validation, failure tracking, lockout enforcement, and session/token issuance.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserLoginRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserLoginResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUser.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/project/ProjectSettings.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserLoginService.java, backend/services/auth-service/src/main/resources/db/migration/V9__end_user_login_security.sql, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: End-user logins update the existing session from EndUserSessionRepository.findByUserId when available.
  - Gotchas encountered: Add new auth endpoints to SecurityConfig.PUBLIC_ENDPOINTS or they will require JWT.
  - Useful context: Login lockout defaults are stored on ProjectSettings and enforced via EndUser failed_login fields.
---

## 2026-01-26 19:45 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user logout endpoint with end-user JWT authentication, API key validation, and session/refresh token invalidation.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserLogoutResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRefreshTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserSessionRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/security/EndUserPrincipal.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/security/JwtAuthenticationFilter.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserLogoutService.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: End-user JWTs now surface an EndUserPrincipal for SDK auth endpoints like logout.
  - Gotchas encountered: Logout requires both X-API-Key and a valid end-user JWT; missing either yields 401.
  - Useful context: Logout revokes refresh tokens via EndUserRefreshTokenRepository.revokeActiveByUserId and deletes sessions via EndUserSessionRepository.deleteByUserId.
---

## 2026-01-26 19:52 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user refresh endpoint with API key validation, refresh token rotation, and session refresh.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRefreshRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserRefreshResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserRefreshTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRefreshService.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Refresh flows should rotate tokens by revoking the old refresh token and linking it to the replacement.
  - Gotchas encountered: End-user refresh endpoints must be added to SecurityConfig.PUBLIC_ENDPOINTS to avoid JWT gating.
  - Useful context: Refresh updates EndUserSession expiry alongside issuing new tokens.
---

## 2026-01-26 19:56 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user password reset endpoints with hashed reset tokens, 1-hour expiry, and password policy enforcement.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserPasswordForgotRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserPasswordResetRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserPasswordResetResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserPasswordResetToken.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserPasswordResetTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserPasswordResetService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/TokenService.java, backend/services/auth-service/src/main/resources/db/migration/V10__end_user_password_reset_tokens.sql, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Password reset tokens are hashed with TokenService and stored with used_at for single-use enforcement.
  - Gotchas encountered: Password reset endpoints must be in SecurityConfig.PUBLIC_ENDPOINTS to avoid JWT gating.
  - Useful context: Reset should clear failed login counters so users can log in immediately after changing passwords.
---

## 2026-01-26 20:02 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented end-user email verification endpoints with token/code validation, resend flow, and verification token persistence.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserEmailVerificationRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserEmailVerificationResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserResendVerificationRequest.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserEmailVerificationToken.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserEmailVerificationTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserEmailVerificationService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserRegistrationService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/TokenService.java, backend/services/auth-service/src/main/resources/db/migration/V11__end_user_email_verification_tokens.sql, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Email verification tokens are issued on registration and resends mark prior tokens used.
  - Gotchas encountered: Verification endpoints must be added to SecurityConfig.PUBLIC_ENDPOINTS to avoid JWT gating.
  - Useful context: Verification tokens store hashed token/code with 24-hour expiry in end_user_email_verification_tokens.
---

## 2026-01-26 20:10 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented gateway API key enforcement for SDK routes, resolving project context and forwarding it to auth-service.
- Files changed: backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/ApiKeyGatewayFilter.java, backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/filter/ApiKeyResolutionResponse.java, backend/services/gateway-service/src/main/java/dev/auctoritas/gateway/config/RateLimiterConfig.java, backend/services/gateway-service/src/main/resources/application.yml, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/ApiKeyResolutionController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/ApiKeyResolveResponse.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/config/SecurityConfig.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Gateway SDK routes use a separate RequestRateLimiter with apiKeyResolver to enforce per-key limits.
  - Gotchas encountered: The gateway API-key filter must run before route handling to ensure 401s on missing keys.
  - Useful context: Project context is forwarded via X-Project-Id after resolving X-API-Key.
---

## 2026-01-26 23:39 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented persistence tables for password reset tokens and password history.
- Updated password reset token entity to use `password_reset_tokens` with project + request metadata (ip/user-agent).
- Files changed: backend/services/auth-service/src/main/resources/db/migration/V13__password_reset_tokens.sql, backend/services/auth-service/src/main/resources/db/migration/V14__password_history.sql, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserPasswordResetToken.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserPasswordResetService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/api/EndUserAuthController.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/entity/enduser/EndUserPasswordHistory.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserPasswordHistoryRepository.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Auth-service tests use Hibernate schema generation; add/adjust JPA entities when adding Flyway tables.
  - Gotchas encountered: The Maven reactor root is `backend/` (module path is `services/auth-service`).
  - Useful context: `password_reset_tokens` backfills and replaces legacy `end_user_password_reset_tokens`.
---

## 2026-01-26 23:49 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Updated password reset request to always return generic success (no reset token leakage), invalidate prior tokens per user+project, and emit `user.password_reset_requested`.
- Added RabbitMQ DomainEventPublisher wiring, plus dev-only stub email log for reset tokens.
- Files changed: backend/services/auth-service/pom.xml, backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserPasswordResetService.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/repository/EndUserPasswordResetTokenRepository.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/messaging/DomainEventPublisher.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/messaging/NoopDomainEventPublisher.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/messaging/PasswordResetRequestedEvent.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/messaging/RabbitMqDomainEventPublisher.java, backend/services/auth-service/src/main/java/dev/auctoritas/auth/messaging/MessagingConfig.java, backend/services/auth-service/src/main/resources/application.yml, backend/services/auth-service/src/main/resources/application-dev.yml, backend/services/auth-service/src/main/resources/application-test.yml, backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/EndUserPasswordResetServiceTest.java, docker-compose.yml, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Auth-service emits RabbitMQ domain events via DomainEventPublisher; publish failures should not block generic-success endpoints.
  - Gotchas encountered: When asserting bulk update queries in transactional tests, flush inserted rows before running the update.
  - Useful context: docker-compose wires auth-service to RabbitMQ via `RABBITMQ_HOST=rabbitmq`.
---

## 2026-01-26 23:57 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented password reset completion safeguards: validate token belongs to API key project, enforce password history, record previous password hash, mark token used, and revoke sessions/refresh tokens.
- Files changed: backend/services/auth-service/src/main/java/dev/auctoritas/auth/service/EndUserPasswordResetService.java, backend/services/auth-service/src/test/java/dev/auctoritas/auth/service/EndUserPasswordResetServiceTest.java, prd.json, progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Store the previous password hash in password_history on change/reset; enforce reuse by comparing candidate password against current + last (N-1) history hashes.
  - Gotchas encountered: In transactional tests, persisting entities after entityManager.clear() requires reloading the referenced entities first.
  - Useful context: End-user password resets should clear login lockouts and revoke all refresh tokens + sessions (logout everywhere).
---
